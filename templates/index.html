<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>Radar | Global</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --primary: #ffd54f; --bg: #050510; --card: #13132b; --text: #e0e0e0; }
    body { background-color: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin:0; padding:20px; }
    .card { background: var(--card); padding:20px; border-radius:12px; margin-bottom:15px; }
    .btn { padding:12px 16px; border-radius:10px; border:none; font-weight:600; cursor:pointer; }
    .btn-pay { background: linear-gradient(135deg,#ffd700,#ff9800); color:#111; }
    .center { max-width:720px; margin:20px auto; }
    .rtl { direction:rtl; }
    .consent-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .consent-box { background:#111; padding:20px; border-radius:12px; max-width:420px; color:#fff; box-shadow:0 6px 30px rgba(0,0,0,0.6); }
    .consent-title { font-size:18px; margin-bottom:8px; color:var(--primary); }
    .muted { color:#aaa; font-size:13px; }
  </style>
</head>
<body id="main-body">
  <div class="center">
    <h1 id="lbl-title">Radar</h1>
    <div class="card" id="main-card">
      <p id="lbl-share-desc" class="muted">…</p>
      <input id="my-link" type="text" style="width:100%;padding:10px;border-radius:8px;border:1px solid #222;background:#000;color:#fff" readonly>
      <button id="btn-copy" class="btn" style="margin-top:12px;">Copy</button>
    </div>

    <div id="visits-list" class="card"></div>
  </div>

  <div id="consent-overlay" style="display:none"></div>

<script>
(function(){
  const tg = window.Telegram?.WebApp;
  try { tg?.expand(); } catch(e){}
  const user = tg?.initDataUnsafe?.user || null;

  // translations for consent + basic strings (9 langs)
  const i18n = {
    en: { title: "Radar Profile", share: "Share this link to see who stalks you.", copy: "Copy Link", consent_title: "✨ This profile uses Radar", consent_text: "By visiting this link you agree that your public info (name, profile photo, ID) may be shown to the owner. ", consent_more: "Learn more", consent_accept: "I Agree", caught: "Visit Recorded!", caught_desc: "This user tracks profile visits. Your info may be captured.", unknown: "Anonymous" },
    fa: { title: "رادار پروفایل", share: "این لینک را در بیو بگذارید تا ببینید چه کسی پروفایل شما را چک می‌کند.", copy: "کپی لینک", consent_title: "✨ این پروفایل از رادار استفاده می‌کند", consent_text: "با بازدید از این لینک، موافقت می‌کنید که اطلاعات عمومی شما (نام، عکس، شناسه) به صاحب لینک نمایش داده شود. ", consent_more: "بیشتر بدانید", consent_accept: "قبول دارم", caught: "بازدید ثبت شد!", caught_desc: "این کاربر رادار دارد و اطلاعات ممکن است ثبت شود.", unknown: "ناشناس" },
    ru: { title:"Радар Профиля", share:"Поделитесь этой ссылкой, чтобы узнать, кто заходил.", copy:"Скопировать", consent_title:"✨ Этот профиль использует Радар", consent_text:"Посещая ссылку, вы соглашаетесь, что ваша публичная информация может быть показана владельцу.", consent_more:"Подробнее", consent_accept:"Я согласен", caught:"Визит записан!", caught_desc:"Этот пользователь отслеживает визиты.", unknown:"Аноним" },
    es: { title:"Radar de Perfil", share:"Comparte esto para ver quién visita tu perfil.", copy:"Copiar enlace", consent_title:"✨ Este perfil usa Radar", consent_text:"Al visitar este enlace acepta que su información pública pueda mostrarse al propietario.", consent_more:"Más información", consent_accept:"Acepto", caught:"¡Visita Registrada!", caught_desc:"Este usuario monitorea visitantes.", unknown:"Anónimo" },
    hi: { title:"प्रोफ़ाइल रडार", share:"यह देखने के लिए लिंक शेयर करें कि आपकी प्रोफ़ाइल कौन देखता है।", copy:"लिंक कॉपी करें", consent_title:"✨ यह प्रोफ़ाइल रडार का उपयोग करती है", consent_text:"इस लिंक पर जाने पर आप सहमत होते हैं कि आपकी सार्वजनिक जानकारी मालिक को दिखाई जा सकती है।", consent_more:"और पढ़ें", consent_accept:"मैं सहमत हूँ", caught:"विज़िट दर्ज की गई!", caught_desc:"यह उपयोगकर्ता विज़िटर को ट्रैक करता है।", unknown:"अज्ञात" },
    ar: { title:"رادار الملف الشخصي", share:"شارك هذا الرابط لتعرف من يزور ملفك الشخصي.", copy:"نسخ الرابط", consent_title:"✨ هذا الملف يستخدم رادار", consent_text:"من خلال زيارة هذا الرابط، فإنك توافق على أن تُعرض معلوماتك العامة لصاحب الرابط.", consent_more:"اعرف أكثر", consent_accept:"أوافق", caught:"تم تسجيل الزيارة!", caught_desc:"هذا المستخدم يتتبع الزوار.", unknown:"مجهول" },
    zh: { title:"个人资料雷达", share:"分享此链接以查看谁在查看您的个人资料。", copy:"复制链接", consent_title:"✨ 此个人资料使用雷达", consent_text:"访问此链接即表示您同意您的公开信息可能会显示给所有者。", consent_more:"了解更多", consent_accept:"我同意", caught:"访问已记录！", caught_desc:"该用户正在追踪访客。", unknown:"匿名" },
    pt: { title:"Radar de Perfil", share:"Compartilhe para ver quem visita seu perfil.", copy:"Copiar Link", consent_title:"✨ Este perfil usa Radar", consent_text:"Ao visitar este link você concorda que suas informações públicas podem ser mostradas ao dono.", consent_more:"Saiba mais", consent_accept:"Eu concordo", caught:"Visita Registrada!", caught_desc:"Este usuário monitora visitantes.", unknown:"Anônimo" },
    id: { title:"Radar Profil", share:"Bagikan link ini untuk melihat siapa yang mengintip profilmu.", copy:"Salin Tautan", consent_title:"✨ Profil ini menggunakan Radar", consent_text:"Dengan mengunjungi link ini Anda setuju informasi publik Anda dapat ditampilkan kepada pemilik.", consent_more:"Pelajari lebih lanjut", consent_accept:"Saya setuju", caught:"Kunjungan Tercatat!", caught_desc:"Pengguna ini melacak pengunjung.", unknown:"Anonim" }
  };

  const langFromTG = user?.language_code?.split('-')?.[0];
  const langFromBrowser = navigator.language?.split('-')?.[0];
  const lang = (langFromTG || langFromBrowser || 'en').toLowerCase();
  const t = i18n[lang] || i18n['en'];
  const isRTL = ['fa','ar','he'].includes(lang);

  if (isRTL) document.getElementById('main-body').classList.add('rtl');

  // Apply basic texts
  document.getElementById('lbl-title').innerText = t.title;
  document.getElementById('lbl-share-desc').innerText = t.share;
  document.getElementById('btn-copy').innerText = t.copy;

  // build link (BOT_USERNAME replaced by server templating when rendered)
  const botName = "{{ BOT_USERNAME | default('YourBotName') }}";
  const startParam = tg?.initDataUnsafe?.start_param || new URLSearchParams(window.location.search).get('start') || '';
  const ownerIdFromParam = startParam && startParam.startsWith('u_') ? startParam.split('_')[1] : null;

  // Show dashboard link
  const myLink = `https://t.me/${botName}?start=u_${user?.id || '0'}`;
  document.getElementById('my-link').value = myLink;

  // Consent logic: show only when visitor (start param present and owner != visitor) and user exists
  const isVisitor = Boolean(ownerIdFromParam && user && String(ownerIdFromParam) !== String(user.id));

  const consentKey = 'radar_consent_u_' + (ownerIdFromParam || 'none');

  function showConsent(){
    // if consent previously given for this owner, skip
    if (localStorage.getItem(consentKey)) return;
    const overlay = document.getElementById('consent-overlay');
    overlay.style.display = 'block';
    overlay.innerHTML = `
      <div class="consent-box" role="dialog" aria-modal="true">
        <div class="consent-title">${t.consent_title}</div>
        <div class="muted" style="margin-bottom:10px">${t.consent_text}<a href="/privacy" style="color:var(--primary); margin-left:6px;">${t.consent_more}</a></div>
        <button id="consent-accept" class="btn btn-pay" style="width:100%">${t.consent_accept}</button>
      </div>
    `;
    document.getElementById('consent-accept').onclick = ()=>{
      localStorage.setItem(consentKey, '1');
      overlay.style.display = 'none';
      // proceed to track (call track endpoint)
      trackVisit();
    };
  }

  // copy link
  document.getElementById('btn-copy').onclick = ()=>{
    navigator.clipboard.writeText(document.getElementById('my-link').value).then(()=>{
      try{ tg.showPopup({message: t.copy + ' OK!'}) }catch(e){ alert(t.copy + ' OK!') }
    }).catch(()=>{ try{ tg.showAlert('Unable to copy') }catch(e){} });
  };

  async function trackVisit(){
    if (!ownerIdFromParam) return;
    try {
      await fetch('/api/track', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ owner_id: ownerIdFromParam, visitor_data: user })
      });
    } catch(e){ console.warn(e); }
  }

  // Load visits when dashboard
  async function loadVisits(){
    try {
      const res = await fetch(`/api/my_dashboard/${user?.id || 0}`);
      if(!res.ok) return;
      const visits = await res.json();
      const container = document.getElementById('visits-list');
      container.innerHTML = '<h3 style="margin-top:0">Visits</h3>';
      if(!visits.length) { container.innerHTML += '<div class="muted">No visits yet</div>'; return; }
      visits.forEach(v=>{
        const unlocked = Number(v.is_unlocked) === 1;
        const name = unlocked ? (v.visitor_name || t.unknown) : t.unknown;
        const photo = unlocked && v.visitor_photo ? v.visitor_photo : 'https://placehold.co/50/222/FFF?text=?';
        const div = document.createElement('div');
        div.style.display='flex';
        div.style.justifyContent='space-between';
        div.style.alignItems='center';
        div.style.padding='8px 0';
        div.innerHTML = `
          <div style="display:flex;align-items:center;gap:10px">
            <img src="${photo}" style="width:42px;height:42px;border-radius:50%;object-fit:cover;border:2px solid var(--primary)">
            <div>
              <div style="font-weight:600">${name}</div>
              <div class="muted" style="font-size:12px">${new Date(v.timestamp).toLocaleString()}</div>
            </div>
          </div>
          <div>${unlocked?'<span style="color:var(--primary)">✓</span>':'<button class="btn btn-pay" onclick="window.alert(\'Payment flow not enabled in this bundle\')">Unlock</button>'}</div>
        `;
        container.appendChild(div);
      });
    } catch(e){ console.warn(e); }
  }

  // On load: if visitor then show consent before tracking; if dashboard show visits
  window.addEventListener('DOMContentLoaded', ()=>{
    if (!user) {
      document.getElementById('main-card').innerHTML = '<p class="muted">Please open inside Telegram.</p>';
      return;
    }
    if (isVisitor) {
      // Show consent overlay if not already accepted; otherwise track immediately
      if (!localStorage.getItem(consentKey)) showConsent();
      else trackVisit();
    } else {
      // dashboard
      loadVisits();
    }
  });

})();
</script>
</body>
</html>
